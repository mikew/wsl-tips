#!/usr/bin/env bash
set -e

source "$(dirname "$0")/wsl-systemd-env"

SYSTEMD_PID=$(wsl-systemd-get-pid)

if [ -z "$1" ]; then
  NSENTER_CMD=(runuser -l -s "$WSL_SYSTEMD_SHELL" "$WSL_SYSTEMD_USER")
else
  CMD="$1"
  shift
  NSENTER_CMD=(runuser "$WSL_SYSTEMD_USER" -s "$(which "$CMD")" -- "$@")
fi

if [ -n "$SYSTEMD_PID" ] && [ "$SYSTEMD_PID" != "1" ]; then
  exec /usr/bin/nsenter \
    -t "$SYSTEMD_PID" \
    -a \
    "${NSENTER_CMD[@]}"
fi
